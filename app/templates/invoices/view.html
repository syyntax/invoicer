{% extends "base.html" %}

{% block title %}Invoice {{ invoice.invoice_number }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="display-5">Invoice <span class="text-primary">{{ invoice.invoice_number }}</span></h1>
    <div>
        <a href="{{ url_for('main.create_edit_invoice', invoice_id=invoice.id) }}" class="btn btn-secondary me-2">
            <i class="fas fa-edit me-1"></i> Edit
        </a>
        <div class="btn-group me-2">
            <button type="button" class="btn btn-info dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-file-export me-1"></i> Export
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="{{ url_for('main.export_invoice_html', invoice_id=invoice.id) }}" target="_blank">HTML</a></li>
                <li><a class="dropdown-item" href="{{ url_for('main.export_invoice_pdf', invoice_id=invoice.id) }}" target="_blank">PDF</a></li>
            </ul>
        </div>
        <form action="{{ url_for('main.update_invoice_status', invoice_id=invoice.id) }}" method="POST" class="d-inline">
            <input type="hidden" name="status" value="{% if invoice.status == 'OUTSTANDING' %}PAID{% else %}OUTSTANDING{% endif %}">
            <button type="submit" class="btn {% if invoice.status == 'OUTSTANDING' %}btn-success{% else %}btn-warning text-dark{% endif %}">
                <i class="fas {% if invoice.status == 'OUTSTANDING' %}fa-check-circle{% else %}fa-undo-alt{% endif %} me-1"></i> 
                Mark as {% if invoice.status == 'OUTSTANDING' %}Paid{% else %}Outstanding{% endif %}
            </button>
        </form>
    </div>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h4 class="mb-3">From:</h4>
                <address>
                    <strong>{{ company.name }}</strong><br>
                    {{ company.address_line1 }}<br>
                    {% if company.address_line2 %}{{ company.address_line2 }}<br>{% endif %}
                    {{ company.city }}, {{ company.state }} {{ company.zip_code }}<br>
                    Email: <a href="mailto:{{ company.email }}">{{ company.email }}</a><br>
                    Phone: {{ company.phone }}
                </address>
            </div>
            <div class="col-md-6 text-md-end">
                <h4 class="mb-3">To:</h4>
                <address>
                    <strong>{{ invoice.recipient.client_name }}</strong><br>
                    {{ invoice.recipient.address_line1 }}<br>
                    {% if invoice.recipient.address_line2 %}{{ invoice.recipient.address_line2 }}<br>{% endif %}
                    {{ invoice.recipient.city }}, {{ invoice.recipient.state }} {{ invoice.recipient.zip_code }}<br>
                    Email: <a href="mailto:{{ invoice.recipient.email }}">{{ invoice.recipient.email }}</a><br>
                    Phone: {{ invoice.recipient.phone }}
                </address>
            </div>
        </div>

        <hr class="my-4">

        <div class="row mb-4">
            <div class="col-md-6">
                <p><strong>Invoice Number:</strong> {{ invoice.invoice_number }}</p>
                <p><strong>Date Created:</strong> {{ invoice.date_created.strftime('%Y-%m-%d') }}</p>
                <p><strong>Date Due:</strong> {% if invoice.date_due %}{{ invoice.date_due.strftime('%Y-%m-%d') }}{% else %}N/A{% endif %}</p>
            </div>
            <div class="col-md-6 text-md-end">
                <p><strong>Status:</strong> 
                    <span class="badge {% if invoice.status == 'PAID' %}bg-success{% else %}bg-warning text-dark{% endif %} fs-6">
                        {{ invoice.status }}
                    </span>
                </p>
                <h3 class="mt-3">Total Due: <span class="text-primary">{{ "%.2f"|format(invoice.total_due) }} {{ '$' if company else '' }}</span></h3>
            </div>
        </div>

        <h4 class="mb-3">Line Items:</h4>
        <div class="table-responsive mb-4">
            <table class="table table-bordered table-striped">
                <thead class="table-light">
                    <tr>
                        <th>Description</th>
                        <th class="text-end" style="width: 10%;">Quantity</th>
                        <th class="text-end" style="width: 15%;">Unit Price</th>
                        <th class="text-end" style="width: 15%;">Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in invoice.line_items %}
                    <tr>
                        <td>{{ item.description }}</td>
                        <td class="text-end">{{ "%.2f"|format(item.quantity) }}</td>
                        <td class="text-end">{{ "%.2f"|format(item.unit_price) }} {{ '$' if company else '' }}</td>
                        <td class="text-end">{{ "%.2f"|format(item.total) }} {{ '$' if company else '' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="3" class="text-end fw-bold">Grand Total:</td>
                        <td class="text-end fw-bold text-primary fs-5">{{ "%.2f"|format(invoice.total_due) }} {{ '$' if company else '' }}</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>
{% endblock %}